# ===============================================================
# ðŸ“¦ Secure Docker Build & Scan Workflow
# ===============================================================
#
# This workflow:
#   - Builds and tags the container image (`latest` + timestamp)
#   - Re-uses a BuildKit layer cache for faster rebuilds
#   - Lints the Dockerfile with **Hadolint** (CLI) â†’ SARIF
#   - Lints the finished image with **Dockle** (CLI) â†’ SARIF
#   - Generates an SPDX SBOM with **Syft**
#   - Scans the image for CRITICAL CVEs with **Trivy/Grype**
#   - Uploads Hadolint, Dockle and Trivy results as SARIF files
#   - Pushes the image to **GitHub Container Registry (GHCR)**
#   - Signs & attests the image with **Cosign (key-less OIDC)**
#
# Triggers:
#   - Every push / PR to `main`
#   - Weekly scheduled run (Tue 18:17 UTC) to catch new CVEs
# ---------------------------------------------------------------

name: Build and push container image to ECR
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]


# -----------------------------------------------------------------
# Minimal permissions - keep the principle of least privilege
# -----------------------------------------------------------------
permissions:
  contents: read
  packages: write # push to ghcr.io via GITHUB_TOKEN
  security-events: write # upload SARIF to "Code scanning"
  actions: read # needed by upload-sarif in private repos
  id-token: write # required for OIDC token generation

jobs:
    build-scan-sign:
        runs-on: ubuntu-latest

        env:
            CACHE_DIR: /tmp/.buildx-cache # BuildKit layer cache dir


        steps:
            # -------------------------------------------------------------
            # 0ï¸âƒ£  Checkout source
            # -------------------------------------------------------------
            -   name: â¬‡ï¸  Checkout code
                uses: actions/checkout@v5

            # -------------------------------------------------------------
            # 0ï¸âƒ£.5ï¸âƒ£  Derive lower-case IMAGE_NAME for Docker tag
            # -------------------------------------------------------------
            -   name: ðŸ·ï¸  Set IMAGE_NAME (lower-case repo path)
                run: |
                    IMAGE="196525939274.dkr.ecr.eu-central-1.amazonaws.com/$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')"
                    echo "IMAGE_NAME=$IMAGE" >> "$GITHUB_ENV"
                    echo "Will build & push: $IMAGE_NAME"

            # -------------------------------------------------------------
            # 2ï¸âƒ£  Set up Buildx & restore cache
            # -------------------------------------------------------------
            -   name: ðŸ› ï¸  Set up Docker Buildx
                uses: docker/setup-buildx-action@v3.11.1

            -   name: ðŸ”„  Restore BuildKit layer cache
                uses: actions/cache@v4
                with:
                    path: ${{ env.CACHE_DIR }}
                    key: ${{ runner.os }}-buildx-${{ github.sha }}
                    restore-keys: ${{ runner.os }}-buildx-

            # -------------------------------------------------------------
            # 3ï¸âƒ£  Build & tag image (timestamp + latest)
            # -------------------------------------------------------------
            -   name: ðŸ—ï¸  Build Docker image
                env:
                    DOCKER_CONTENT_TRUST: "1"
                run: |
                    TAG=$(date +%s)
                    echo "TAG=$TAG" >> "$GITHUB_ENV"
                    docker buildx build \
                      --file Containerfile.lite \
                      --tag $IMAGE_NAME:$TAG \
                      --tag $IMAGE_NAME:latest \
                      --cache-from type=local,src=${{ env.CACHE_DIR }} \
                      --cache-to   type=local,dest=${{ env.CACHE_DIR }},mode=max \
                      --load \
                      .   # build context is mandatory

            -   name: Configure AWS credentials
                uses: aws-actions/configure-aws-credentials@v1
                with:
                    aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                    aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                    aws-region: "eu-central-1"

            -   name: Login to Amazon ECR
                id: login-ecr
                uses: aws-actions/amazon-ecr-login@v1
            -   name: Build, tag, and push image to Amazon ECR
                id: build-image
                env:
                    ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                    IMAGE_TAG: ${{ github.sha }}
                run: |
                    docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
                    echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
